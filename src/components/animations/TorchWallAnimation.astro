<script>
    import { TorchWallAnimationController } from "@/lib/animations/torchWallAnimationController";

    // Global singleton to prevent multiple instances
    declare global {
        interface Window {
            __torchWallController?: TorchWallAnimationController;
        }
    }

    function animateTorchWall() {
        document.addEventListener("astro:page-load", () => {
            const canvas = document.getElementById(
                "torchWallCanvas",
            ) as HTMLCanvasElement | null;
            
            if (!canvas) {
                return;
            }

            // Cleanup existing instance if it exists
            if (window.__torchWallController) {
                window.__torchWallController.cleanup();
                window.__torchWallController = undefined;
            }

            // Restore mouse position from sessionStorage if available
            const storedPosition = sessionStorage.getItem('torchPosition');
            let initialPosition;
            if (storedPosition) {
                initialPosition = JSON.parse(storedPosition);
            }

            const controller = new TorchWallAnimationController(canvas, initialPosition);
            window.__torchWallController = controller;
            controller.start();

            // Save position before navigation
            document.addEventListener("astro:before-preparation", () => {
                if (window.__torchWallController) {
                    const currentPosition = window.__torchWallController.getMousePosition();
                    sessionStorage.setItem('torchPosition', JSON.stringify(currentPosition));
                    window.__torchWallController.cleanup();
                    window.__torchWallController = undefined;
                }
            }, { once: true });
        });
    }
    
    animateTorchWall();
</script>
