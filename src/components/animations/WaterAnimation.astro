<script>
    import { WaterAnimationController } from "@/lib/animations/waterAnimationController";

    // Global singleton to prevent multiple instances
    declare global {
        interface Window {
            __waterController?: WaterAnimationController;
        }
    }

    function animateWater() {
        document.addEventListener("astro:page-load", () => {
            const canvas = document.getElementById(
                "waterCanvas",
            ) as HTMLCanvasElement | null;
            
            if (!canvas) {
                return;
            }

            // Cleanup existing instance if it exists
            if (window.__waterController) {
                window.__waterController.cleanup();
                window.__waterController = undefined;
            }

            const controller = new WaterAnimationController(canvas, "Nandan Varma");
            window.__waterController = controller;
            controller.start();

            // Cleanup on page unload
            document.addEventListener("astro:before-preparation", () => {
                if (window.__waterController) {
                    window.__waterController.cleanup();
                    window.__waterController = undefined;
                }
            }, { once: true });
        });
    }
    
    animateWater();
</script>
